{% extends "dasmon/live_monitor.html" %}
{% load dasmon_tags %}

{% block title %}{{ instrument }} Process Variables {% endblock %}

{% block banner %}{{ instrument }} Process Variables {% endblock %}    

{% block header %}

<!--[if lte IE 8]><script language="javascript" type="text/javascript" src="/static/thirdparty/flot/excanvas.min.js"></script><![endif]-->
<script language="javascript" type="text/javascript" src="/static/thirdparty/flot/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="/static/thirdparty/d3.v3/d3.v3.min.js"></script>
<script language="javascript" type="text/javascript" src="/static/live_update.js"></script>
<script language="javascript" type="text/javascript" src="/static/bar_chart.js"></script>
<script language="javascript" type="text/javascript" src="/static/plotting_line.js"></script>
<link rel="stylesheet" type="text/css" href="/static/plotting.css" title="no title" charset="utf-8">
<link rel="stylesheet" type="text/css" href="/static/bar_chart.css" />
<link rel="stylesheet" type="text/css" href="/static/thirdparty/flaticon/flaticon.css"> 

<script>
    var last_run_id = '{{ last_run.id }}';
    var run_data = {{ run_rate|safe }};
    var error_data = {{ error_rate|safe }};
    var plotted_data = [];
    var plot_timeframe = '7200';
	var Plots = new Array();
	
	//************************************************************************80
	// FUNCTION: new_monitor
		//
		// Desc: creates an instance of MonitorPlot onclick and stores
		//			in Plots array
		// 
		// Variables: dialog_win_generated, nid
		//
	//************************************************************************80
	function new_monitor(element_id){
		var option = '1';
		var dialog_win_generated = false;	// dialog_win already exists? flag
		var nid = Plots.length; 			// numeric id
		for (var i=0; i<Plots.length; i++){
			// Go through Plots
			if (Plots[i].element_id === element_id){
				dialog_win_generated = true;
				nid = i;
			}
		}
		if (dialog_win_generated === false){
			// If dialog win has not been generated already
			Plots.push(1);
			nid = Plots.length-1;
			// Create new instance of MonitorPlot
			Plots[nid] = new MonitorPlot(element_id, nid, option);
		}
		else if (dialog_win_generated === true){
			// If dialog win has been generated already get plot
			Plots[nid].option = option;
		}
		Plots[nid].pop_monitor_plot();
	}
	
	//************************************************************************80
	// OBJECT: MonitorPlot
		//
		// Desc: handles each plot on monitor page
		//
		// Variables: element_id, nid, clean_name, dialog_name
		// 		dialog_win, plot_id, plot_content, submenu, 
		//		plot_options{}, 
		// 
		// Methods: pop_monitor_plot, prepare_menu, local_options, 
		// 		check_scale, close_l_opt
		// 
	//************************************************************************80
	function MonitorPlot(element_id, nid, option){

		this.element_id = element_id;
		this.nid = nid;
		this.option = option;
		this.clean_name = element_id.replace(/:/g, '_');
		this.dialog_name = this.clean_name + "_dialog";
		this.dialog_win;
		this.plot_id = this.clean_name + "_plot";
		this.plotted_data = [];
		this.plot_content = 
			"<div id='" + this.dialog_name + "' title='" + this.element_id + "' name='" + this.element_id + "'>" + 
			"	<div class='live_plots'>" +
			"		<div class='options' style='float:left'>" +
			"			<a class='flaticon_link' onclick='Plots[" + nid + "].prepare_menu(\"" + this.dialog_name + "\")'>" +
			"			<span class='flaticon flaticon-settings22'></span></a>" +
			"		</div>" +
			"	</div><br><br>" +
			"	<div class='plot_timeframe'>" +
			"		<a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"900\");'>15m</a> | " +
			"		<a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"7200\");'>2h</a> | " +
			"		<a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"86400\");'>max</a> " +
			"	</div><br>" +
			"	<div id='" + this.clean_name + "_plot'></div>" +
			"	</div>" +
			"</div>";
		this.plot_options = {
			// plot options here!
			log_scale: false,
			psize: {width: 485, height: 250}
		}
		this.pop_monitor_plot = function(){
			// Create dialog box for plot and call poll
			if ($("#" + this.dialog_name).length === 0){
				var element_id = this.element_id;
				var dialog_name = this.dialog_name;
				var nid = this.nid;
				var plot_id = this.plot_id;
				$('#dialog_placeholder').append(this.plot_content);
				$("#" + this.dialog_name).dialog({
					width: 535,
					height: 380,
					dialogClass: "plot_class",
					resizable: true,
					closeOnEscape: true,
					resize: function(event, ui){
						dialog_resize(event, ui, nid, this);
					},
					close: function(event, ui) {
						Plots[nid].option = "0";
						Plots[nid].plot_options.psize = {width: 485, height: 250}; // restore default size
						$("#" + dialog_name).remove();
						if($("#" + dialog_name + "_submenu").length > 0){
							$("#" + dialog_name + "_submenu").remove();
						}
					},
					open: function (event, ui) {
						$("#" + this.dialog_name).css('overflow', 'hidden'); //this line does the actual hiding
					}
				});
				// Get dialog window DOM element
				this.dialog_win = $("#" + this.dialog_name).parent();
				//resize_dialog(element_id);
			}
            poll();
		}
		this.submenu = '<div id="' + this.dialog_name + 
						'_submenu" class="submenu"><a id="local_options_link" ' + 
						'class="ui-button" onclick="Plots[' + nid + '].local_options(\'' +
						 this.dialog_name + '\')" style="width:88px">Local options</a><br>' + 
						'<a id="global_options_link" class="ui-button" ' + 
						'onclick="global_options(\'' + this.dialog_name + 
						'\')" style="width:88px">Global options</a></div>';
		this.prepare_menu = function(){
			// Toggle submenu (for plot options)
			if($("#" + this.dialog_name + "_submenu").length === 0){
				$("#" + this.dialog_name + " .options").append(this.submenu);
			}
			else if($("#" + this.dialog_name + "_submenu").length > 0){
				$("#" + this.dialog_name + "_submenu").remove();
			}
		}
		this.local_options = function(){
			if($("#" + this.dialog_name + "_submenu").length > 0){
				// Remove submenu if it's open
				$("#" + this.dialog_name + "_submenu").remove();
			}	
			if ($("#local_options_" + this.dialog_name).length === 0){
				var cur_height = $(this.dialog_win).height();
				var new_height = cur_height + 100;	
				var lin_radio;
				var log_radio;
				var html;
				if (this.plot_options.log_scale === false){
					lin_radio = "checked='checked'"; log_radio = "";
				}
				else{
					log_radio = "checked='checked'"; lin_radio = "";
				}
				html = "<div id='local_options_" + this.dialog_name + "' style='height:100px;border-top:1px solid lightgrey;padding:5px'>" + 
						"<a class='flaticon_link' onclick='Plots[" + nid + "].close_l_opt(\"local_options_" + this.dialog_name + "\")'>" + 
						"<span class='flaticon flaticon-close19' style='float:right'></span></a>" + 
						"<h3>Local Options</h3>" +
						"<form name='form_" + this.dialog_name + "'>" + 
						"<div id='radio_" + this.dialog_name + "'>y scale: <input type='radio' class='check_scale' " + 
						"id='scale_log_" + this.dialog_name + "' name='radio' " + log_radio + "onclick='Plots[" + nid + "].check_scale()'>" +
						"<label for='scale_log_" + this.dialog_name + "' id='scale_log_label_" + this.clean_name + "'>log</label>" +
						"<input type='radio' class='check_scale' id='scale_lin_" + this.dialog_name + "' name='radio' " + lin_radio +  
						"onclick='Plots[" + nid + "].check_scale()'>" +
						"<label for='scale_lin_" + this.dialog_name + "' id='scale_lin_label_" + this.clean_name + "'>linear</label></div></form></div>";
				this.dialog_win.css("height", new_height);
				$("#" + this.dialog_name).after(html);
				$("#radio_" + this.dialog_name).buttonset();
			}
		}
		this.check_scale = function(){
			// Change scale
			if ($("#scale_log_label_" + this.clean_name).hasClass("ui-state-active")){
				this.plot_options.log_scale = true;
				poll();
			}
			else if ($("#scale_lin_label_" + this.clean_name).hasClass("ui-state-active")){
				this.plot_options.log_scale = false;
				poll();
			}
		}
		this.close_l_opt = function(){
			// Close local options bar
			var cur_height = $(this.dialog_win).height();
			var new_height = cur_height - 100;
			this.dialog_win.css("height", new_height);
			$("#local_options_" + this.dialog_name).remove();
		}
	}
	
    function dialog_resize(event, ui, nid, s){
		var adj_size = {width: $(s).width()-25, height: $(s).height()-80};
		Plots[nid].plot_options.psize = adj_size;
		plot_1d(Plots[nid].plotted_data, Plots[nid].plot_id, Plots[nid].plot_options)
	}

    function poll() {
        query_str = "";
        for (var i=0;i<Plots.length; i++) {
            if (Plots[i].option === "1") query_str += Plots[i].element_id + ",";
        }
        $.ajax({ url: "{{ update_url }}?time="+plot_timeframe+"&vars="+query_str, success: function(data) {
            update_from_ajax_data(data);
            $('#info_last_run').replaceWith("<span id='info_last_run'><a href='{{ base_run_url }}"+data.last_run+"/'>"+data.last_run+"</a></span>");
            $('#info_last_expt').replaceWith("<span id='info_last_expt'><a href='{{ base_ipts_url }}"+data.last_expt+"/'>"+data.last_expt+"</a></span>");
            $('#info_run_time').replaceWith("<span id='info_run_time'>"+data.last_run_time+"</span>");
            
            run_data = data.run_rate;
            error_data = data.error_rate;
            plotted_data = data.live_plot_data;
            plot_combined_rates(run_data, error_data);
            
            //for (var i=0; i<plotted_vars.length; i++) {
                //for (var j=0; j<plotted_data.length; j++) {
                    //if (plotted_data[j][0]==plotted_vars[i][0]) {
                        //var plot_id = "#"+plotted_vars[i][0].replace(/:/g, '_')+"_plot";
                        //plot_monitor(plotted_data[j][1], plot_id, plotted_vars[i][0]);
                    //}
                //}
            //}
            for (var i=0; i<data.live_plot_data.length; i++){
				for (var j=0; j<Plots.length; j++){
					if (data.live_plot_data[i][0] === Plots[j].element_id){
						Plots[j].plotted_data = data.live_plot_data[i][1];
						plot_1d(Plots[j].plotted_data, Plots[j].plot_id, Plots[j].plot_options)
						break;
					}
				}
			}
        }, dataType: "json", timeout: 30000, cache: true,
        statusCode: { 401: function() { new_alert("Your session expired. Please log in again"); show_alert(); }}});
    };
    
    function max_timeframe(time_period) 
    {
        plot_timeframe = time_period;
        poll();
    }
    
    
	function global_options(dialog_name){
		if ($("#" + dialog_name + "_submenu").length > 0){
			// Remove submenu if it's open
			$("#" + dialog_name + "_submenu").remove();
		}
		if ($("#global_options").length === 0){
			// If global options dialog box doesn't exist make one
			var g_opt_win = "<div id='global_options' title='Global options'>" + 
							"<h3>Global options</h3>" + 
							"Global options settings</div>";
			$("#dialog_placeholder").append(g_opt_win);
			$("#global_options").dialog({
				width: 400,
				height: 280,
				resizable: true,
				closeOnEscape: true,
				close: function( event, ui ){
					$("#global_options").remove();
				}
			});
		}
		else{ // If global options dialog box exists move to top
			$("#global_options").dialog({
				position: 'top'
			});
		}
	}

    //function pop_monitor_plot(element_id)
    //{
        //var clean_name = element_id.replace(/:/g, '_');
        //var dialog_name = clean_name+"_dialog"
        //if (!$("#"+dialog_name).length)
        //{
            //var plot_content = "<div id='"+dialog_name+"' title='"+element_id+"'>";
            //plot_content    += "  <div class='live_plots'>";
	    //plot_content    += "    <div class='options'>";
	    //plot_content    += "      <span class='ui-icon ui-icon-gear'></span>";
	    //plot_content    += "    </div>";
            //plot_content    += "    <div class='plot_timeframe'>";
            //plot_content    += "      <a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"900\");'>15m</a> | ";
            //plot_content    += "      <a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"7200\");'>2h</a> | ";
            //plot_content    += "      <a style='outline:none;' href='javascript:void(0);' onClick='max_timeframe(\"86400\");'>max</a>";
            //plot_content    += "    </div><br>";
            //plot_content    += "    <div style='height:150px' id='"+clean_name+"_plot'><span class='waiting'>Working... this will take a second or two.</span></div>";
            //plot_content    += "    <span style='float:right'>time elapsed [minutes]</span><br>";
            //plot_content    += "  </div>";
            //plot_content    += "</div>";
            //$('#dialog_placeholder').append(plot_content);
            //$( "#"+dialog_name ).dialog({
                //width: 400,
                //height: 230,
                //resizable: false,
                //closeOnEscape: true,
                //close: function( event, ui ) 
                //{ 
                    //$( "#"+dialog_name ).remove(); 
                    //for (var i = 0; i < plotted_vars.length; i++) {
                        //if (plotted_vars[i][0]==element_id) plotted_vars[i][1]="0";
                    //};
                //}
            //});
            //plotted_vars.push([element_id, "1"]);
            //poll();
        //}
    //}
</script> 
{% endblock %}

{% block right_side_links %}
    <span style="float:right">live monitoring: 
    <a href="{{ live_monitor_url }}">status</a> | <a href="{{ live_runs_url }}">runs</a> | <b>PVs</b>
    </span>
{% endblock %}

{% block bodytop %}
<script id="source" language="javascript" type="text/javascript">
    setInterval(poll, 5000);
</script>
{% endblock %}

{% block content %}
  <table class="message_table" id="error_table">
    <thead>
      <tr>
        <th> Key </th> <th> Value </th> <th> Last Updated </th>
      </tr>
    </thead>
    <tbody>
      {% for item in key_value_pairs %}
      <tr>
        {% if item.value|is_number %}<td><a href='javascript:void(0);' onClick="new_monitor('{{ item.key }}');"> {{ item.key }} </a></td>{% else %}<td>{{ item.key }}</td>{% endif %}
        <td><span id="{{ item.key }}">{{ item.value }}</span></td>
        <td><span id="{{ item.key }}_timestamp">{{ item.timestamp }}</span></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>

  <div id="dialog_placeholder"></div>

  <script id="source" language="javascript" type="text/javascript">
    plot_combined_rates(run_data, error_data);
  </script>
{% endblock%}
